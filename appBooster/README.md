# AB Testing API

REST API для проведения AB-тестов в мобильных приложениях. Система распределяет устройства по экспериментам с заданными весами и гарантирует, что устройство всегда попадает в одну группу.

## Описание

API для управления AB-тестами:
- Получение списка экспериментов для устройства
- Гарантия постоянства группы для устройства
- Эксперименты только для новых устройств
- Статистика по экспериментам

## Реализация

### Архитектура

Проект организован по структуре, похожей на Go-проекты:

- `cmd/server/` - точка входа, FastAPI приложение
- `internal/models/` - модели базы данных
- `internal/experiments/` - логика управления экспериментами
- `api/schemas/` - схемы API
- `configs/` - конфигурация

### Основные компоненты

**FastAPI приложение** (`cmd/server/main.py`):
- Эндпойнт `/api/v1/experiments` - получение экспериментов для устройства
- Эндпойнт `/api/v1/statistics` - статистика по экспериментам (JSON)
- Эндпойнт `/statistics` - страница статистики (HTML)

**Менеджер экспериментов** (`internal/experiments/manager.py`):
- Создание и управление устройствами
- Распределение устройств по экспериментам с учетом весов
- Проверка, что устройство участвует только в экспериментах, созданных до первого запроса
- Сбор статистики

**Модели данных**:
- `Device` - устройства
- `DeviceExperiment` - назначения устройств на эксперименты
- `Experiment` - эксперименты
- `ExperimentOption` - опции экспериментов с весами

### Эксперименты

**1. Цвет кнопки (`button_color`):**
- `#FF0000` - 33.3%
- `#00FF00` - 33.3%
- `#0000FF` - 33.3%

**2. Стоимость покупки (`price`):**
- `10` - 75%
- `20` - 10%
- `50` - 5%
- `5` - 10%

### Особенности реализации

1. **Постоянство группы**: Устройство всегда получает одно и то же значение эксперимента
2. **Эксперименты для новых устройств**: Устройство участвует только в экспериментах, созданных до его первого запроса
3. **Взвешенное распределение**: Используется алгоритм взвешенного случайного выбора
4. **Статистика**: Подсчет количества устройств и распределения по опциям

## Технологии

- **Python 3.11+**
- **FastAPI** - веб-фреймворк
- **PostgreSQL** - база данных
- **SQLAlchemy** - ORM
- **Jinja2** - шаблоны для HTML страницы

## Установка и запуск

### Локально

1. Установка зависимостей:
```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

Или используйте скрипт:
```bash
./scripts/setup.sh
```

2. Настройка базы данных:
```bash
createdb abtesting
# Или используйте PostgreSQL через Docker
```

3. Запуск:
```bash
# Используется SQLite по умолчанию (файл abtesting.db создается автоматически)
uvicorn cmd.server.main:app --host 127.0.0.1 --port 8000 --reload

# Или с явным указанием DATABASE_URL:
DATABASE_URL=sqlite:///./abtesting.db uvicorn cmd.server.main:app --host 127.0.0.1 --port 8000 --reload
```

API доступен на http://127.0.0.1:8000

### Docker

```bash
docker-compose up --build
```

API доступен на http://localhost:8000

## API

### Получение экспериментов

**GET** `/api/v1/experiments`

**Заголовки:**
- `Device-Token: <уникальный_токен_устройства>`

**Ответ:**
```json
{
  "button_color": "#FF0000",
  "price": "10"
}
```

### Статистика (JSON)

**GET** `/api/v1/statistics`

**Ответ:**
```json
[
  {
    "experiment_key": "button_color",
    "total_devices": 600,
    "distribution": {
      "#FF0000": {"count": 200, "weight": 33, "percentage": 33.33},
      "#00FF00": {"count": 200, "weight": 33, "percentage": 33.33},
      "#0000FF": {"count": 200, "weight": 34, "percentage": 33.34}
    }
  }
]
```

### Статистика (HTML)

**GET** `/statistics`

Отображает таблицу со статистикой по всем экспериментам.

## Использование

### Пример запроса

```bash
curl -H "Device-Token: device-123" http://127.0.0.1:8000/api/v1/experiments
```

### Проверка статистики

Откройте в браузере:
```
http://127.0.0.1:8000/statistics
```

## Тестирование

```bash
pytest
```

С покрытием:
```bash
pytest --cov=cmd --cov=internal --cov=pkg --cov-report=html
```

## Структура проекта

```
appBooster/
├── cmd/server/main.py      # FastAPI приложение
├── internal/
│   ├── models/            # Модели БД
│   ├── experiments/       # Логика экспериментов
│   └── db/                # Подключение к БД
├── api/schemas/           # Схемы API
├── configs/               # Конфигурация
├── templates/             # HTML шаблоны
├── tests/                 # Тесты
└── scripts/               # Скрипты
```

## Переменные окружения

- `DATABASE_URL` - URL базы данных (по умолчанию `postgresql://abtesting:abtesting@localhost:5432/abtesting`)
- `BASE_URL` - базовый URL приложения (по умолчанию `http://localhost:8000`)

## Postman коллекция

Для удобного тестирования создана коллекция Postman:
- `postman_collection.json` - коллекция для импорта в Postman
- `POSTMAN_REQUESTS.md` - описание всех запросов

## Дополнительно

- `Task.md` - описание задания
- `SCREEN.md` - скриншоты работающего приложения
